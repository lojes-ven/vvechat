# vvechat - High-Performance IM Prototype

> ğŸš€ åˆ†å¸ƒå¼ ID ç”Ÿæˆç³»ç»Ÿä¸ LRU ç¼“å­˜ç­–ç•¥å®è·µé¡¹ç›®

vvechat æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å’ŒåŸç”Ÿ JavaScript æ„å»ºçš„å³æ—¶é€šè®¯ï¼ˆIMï¼‰åº”ç”¨é›å½¢ã€‚æœ¬é¡¹ç›®å¹¶éä¸€ä¸ªå®Œæ•´çš„å•†ä¸šçº§èŠå¤©è½¯ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸“æ³¨äº **é«˜æ€§èƒ½ç»„ä»¶è®¾è®¡** çš„æ•™å­¦ä¸å®è·µé¡¹ç›®ã€‚å®ƒé‡ç‚¹æ¨¡æ‹Ÿäº†é€šè®¯åº”ç”¨ä¸­â€œæŸ¥çœ‹æœ€å¸¸è®¿é—®å¥½å‹â€çš„åœºæ™¯ï¼Œå¹¶æ·±å…¥å®è·µäº† **é›ªèŠ±ç®—æ³• (Snowflake)** å’Œ **LRU (Least Recently Used) ç¼“å­˜ç­–ç•¥**ã€‚

## ğŸ“š 1. é¡¹ç›®ç®€ä»‹ (Introduction)

æœ¬ç³»ç»Ÿä¸»è¦è§£å†³äº†ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š

1.  **å…¨å±€å”¯ä¸€ ID ç”Ÿæˆ**ï¼šåœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œä¸ºæ¯ä¸€æ¡æ¶ˆæ¯ã€æ¯ä¸€ä¸ªå¥½å‹å…³ç³»ç”Ÿæˆè¶‹åŠ¿é€’å¢ä¸”ä¸é‡å¤çš„ 64 ä½ IDï¼Œèƒ½å¤Ÿæ‰¿å—é«˜å¹¶å‘è¯·æ±‚ï¼ˆ> 1000 QPSï¼‰ã€‚
2.  **é«˜æ•ˆç¼“å­˜ç®¡ç†**ï¼šåœ¨å‰åç«¯åˆ†åˆ«å®ç° LRU ç¼“å­˜ç­–ç•¥ã€‚
    *   **å‰ç«¯**ï¼šä½¿ç”¨æ‰‹å†™å“ˆå¸Œè¡¨+åŒå‘é“¾è¡¨ç¼“å­˜ `uid` åˆ°å†…éƒ¨ `id` çš„æ˜ å°„ï¼Œå‡å°‘é¢‘ç¹æŸ¥æ‰¾å¼€é”€ã€‚
    *   **åç«¯**ï¼šä¼˜åŒ–â€œæœ€å¸¸è®¿é—®å¥½å‹â€çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œå‡å°‘å¯¹æ•°æ®åº“çš„å‡»ç©¿ã€‚
3.  **å®Œæ•´æ¶æ„å®è·µ**ï¼šä»æ•°æ®åº“è®¾è®¡ã€åç«¯ API å®ç°åˆ°å‰ç«¯äº¤äº’å±•ç°ï¼Œæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„å…¨æ ˆå¼€å‘æ¡ˆä¾‹ã€‚

## ğŸ—ï¸ 2. ç³»ç»Ÿæ¶æ„ (Architecture)

### 2.1 æŠ€æœ¯æ ˆ

| æ¨¡å— | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| **Backend** | **Go 1.25+** | é«˜æ€§èƒ½åç«¯è¯­è¨€ |
| **Framework** | **Gin** | è½»é‡çº§ Web æ¡†æ¶ |
| **Database** | **PostgreSQL** | å…³ç³»å‹æ•°æ®åº“ï¼Œå­˜å‚¨ç”¨æˆ·ä¸å…³ç³»æ•°æ® |
| **Cache** | **Redis** | é«˜é€Ÿç¼“å­˜ |
| **Frontend** | **Vanilla JS** | åŸç”Ÿ JavaScript (æ— æ¡†æ¶)ï¼Œæ‰‹å†™ LRU ç®—æ³• |
| **Testing** | **Python / Node.js** | å‹æµ‹è„šæœ¬ (`id_bench`) ä¸ç®—æ³•åŸºå‡†æµ‹è¯• (`lru_bench`) |

### 2.2 æ¶æ„å›¾

```mermaid
graph TD
    User[Web Client (Browser)] -->|HTTP Requests| Nginx[Web Server / Load Balancer]
    Nginx -->|API Calls| GoApp[Go Backend (Gin)]
    
    subgraph "Backend Services"
        GoApp -->|Auth Middleware| JWT[JWT Validator]
        GoApp -->|Snowflake Algo| IDGen[ID Generator Service]
        GoApp -->|Read/Write| Redis[(Redis Cache)]
        GoApp -->|Persist| DB[(PostgreSQL)]
    end
    
    subgraph "Frontend Engine"
        GUI[index.html] -->|Render| DOM
        Logic[app.js] -->|Fetch| GoApp
        Logic -->|Optimize| LRU[lru_cache.js (Client Cache)]
    end
```

### 2.3 ç›®å½•ç»“æ„è¯´æ˜

```
vvechat/
â”œâ”€â”€ backend/            # Go åç«¯ä»£ç 
â”‚   â”œâ”€â”€ cmd/            # ç¨‹åºå…¥å£ (main.go)
â”‚   â”œâ”€â”€ conf/           # é…ç½®æ–‡ä»¶ (config.yaml)
â”‚   â”œâ”€â”€ internal/       # ä¸šåŠ¡é€»è¾‘ (handler, service, model)
â”‚   â””â”€â”€ pkg/            # å…¬å…±ç»„ä»¶ (snowflake, jwt, response)
â”œâ”€â”€ frontend/           # å‰ç«¯ä»£ç  (çº¯é™æ€æ–‡ä»¶)
â”‚   â””â”€â”€ lru_cache.js    # æ ¸å¿ƒï¼šå‰ç«¯æ‰‹å†™ LRU ç®—æ³•å®ç°
â”œâ”€â”€ test/               # æµ‹è¯•å¥—ä»¶
â”‚   â”œâ”€â”€ id_bench/       # Snowflake ID ç”Ÿæˆå™¨å‹æµ‹ (Python)
â”‚   â”œâ”€â”€ lru_bench/      # LRU ç®—æ³•åŸºå‡†æµ‹è¯• (Node.js/Python)
â”‚   â””â”€â”€ api_test/       # API æ¥å£é›†æˆæµ‹è¯•
â””â”€â”€ docs/               # é¡¹ç›®æ–‡æ¡£
```

## ğŸ› ï¸ 3. éƒ¨ç½²ä¸è¿è¡Œ (Deployment)

### 3.1 ç¯å¢ƒè¦æ±‚

*   **Go**: 1.25.5 æˆ–æ›´é«˜ç‰ˆæœ¬
*   **PostgreSQL**: è¿è¡Œåœ¨ `localhost:5432`
*   **Redis**: è¿è¡Œåœ¨ `localhost:6379`
*   **Python**: 3.8+ (ç”¨äºè¿è¡Œæµ‹è¯•è„šæœ¬)
*   **Node.js**: (å¯é€‰ï¼Œç”¨äºè¿è¡Œå‰ç«¯åŸºå‡†æµ‹è¯•)

### 3.2 å¯åŠ¨æ­¥éª¤

#### ç¬¬ä¸€æ­¥ï¼šé…ç½®æ•°æ®åº“

ç¡®ä¿ PostgreSQL å’Œ Redis æ­£åœ¨è¿è¡Œã€‚
é»˜è®¤é…ç½®ä½äº `backend/conf/config.yaml`ï¼š

```yaml
postgres:
  dsn: "host=localhost user=lojes dbname=wechat port=5432 sslmode=disable TimeZone=Asia/Shanghai"
redis:
  addr: 127.0.0.1:6379
```

è¯·æ ¹æ®ä½ çš„æœ¬åœ°ç¯å¢ƒä¿®æ”¹ `dsn` ä¸­çš„ç”¨æˆ·å (`user`) å’Œæ•°æ®åº“å (`dbname`)ã€‚

#### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨åç«¯

```bash
cd backend
# ä¸‹è½½ä¾èµ–
go mod tidy
# è¿è¡ŒæœåŠ¡
go run cmd/main.go
```
æœåŠ¡é»˜è®¤ç›‘å¬åœ¨ `8080` ç«¯å£ï¼ˆæˆ–æ ¹æ® `config.yaml` é…ç½®ï¼‰ã€‚

#### ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œå‰ç«¯

è¯¥é¡¹ç›®å‰ç«¯ä¸ºçº¯é™æ€æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„ HTTP Server å¯åŠ¨ï¼Œæˆ–è€…ç›´æ¥åœ¨ VS Code ä¸­ä½¿ç”¨ "Live Server" æ’ä»¶æ‰“å¼€ `frontend/index.html`ã€‚

å¦‚æœæ‚¨å®‰è£…äº† Pythonï¼Œä¹Ÿå¯ä»¥å¿«é€Ÿå¯åŠ¨ä¸€ä¸ªé™æ€æœåŠ¡å™¨ï¼š
```bash
cd frontend
python -m http.server 3000
```
ç„¶ååœ¨æµè§ˆå™¨è®¿é—® `http://localhost:3000`ã€‚

## ğŸ§ª 4. æµ‹è¯•å¥—ä»¶ (Testing)

é¡¹ç›®åŒ…å«ä¸€å¥—å®Œå–„çš„æµ‹è¯•å·¥å…·ï¼Œç”¨äºéªŒè¯ç®—æ³•æ€§èƒ½ã€‚

### 4.1 é›ªèŠ±ç®—æ³•å‹æµ‹ (ID Benchmark)

éªŒè¯åˆ†å¸ƒå¼ ID ç”Ÿæˆå™¨çš„æ€§èƒ½ä¸å”¯ä¸€æ€§ã€‚

```bash
cd test/id_bench
# å®‰è£…ä¾èµ– (å»ºè®®åœ¨ venv ä¸­)
pip install matplotlib
# è¿è¡Œå‹æµ‹
python runner.py --duration 10 --workers 4
```

### 4.2 LRU æ€§èƒ½æµ‹è¯•

éªŒè¯å‰ç«¯æ‰‹å†™ LRU ç¼“å­˜çš„æ€§èƒ½ã€‚

```bash
cd test/lru_bench
# è¿è¡Œ Node.js åŸºå‡†æµ‹è¯•
node benchmark_lru.js
```

## ğŸ“ 5. å…³äºé¡¹ç›® (About)

æœ¬é¡¹ç›®æ˜¯ **æ•°æ®ç»“æ„è¯¾ç¨‹è®¾è®¡** çš„äº§å‡ºæˆæœã€‚

*   **æ ¸å¿ƒè´¡çŒ®**:
    *   å°†ç†è®ºå±‚é¢çš„â€œåŒå‘é“¾è¡¨+å“ˆå¸Œè¡¨â€åº”ç”¨äºå®é™…çš„ LRU ç¼“å­˜å®ç°ã€‚
    *   é€šè¿‡ä½è¿ç®—å®ç°é«˜æ•ˆçš„é›ªèŠ±ç®—æ³•ï¼Œè§£å†³äº†åˆ†å¸ƒå¼ ID ç”Ÿæˆéš¾é¢˜ã€‚
    *   æ„å»ºäº†å¯è§†åŒ–çš„åŸºå‡†æµ‹è¯•å·¥å…·ï¼Œç›´è§‚å±•ç¤ºç®—æ³•æ€§èƒ½ã€‚

---
*Created by vvechat Team.*
